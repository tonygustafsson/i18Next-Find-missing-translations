{"version":3,"file":"transform.js","names":["Transform","eol","fs","path","VirtualFile","yaml","i18next","sortKeys","dotPathToHash","mergeHashes","transferValues","makeDefaultSort","Parser","i18nTransform","options","objectMode","defaults","contextSeparator","createOldCatalogs","defaultNamespace","defaultValue","indentation","keepRemoved","keySeparator","lexers","lineEnding","locales","namespaceSeparator","pluralSeparator","output","resetDefaultValueLocale","sort","verbose","customValueTemplate","failOnWarnings","yamlOptions","i18nextOptions","nsSeparator","entries","parserHadWarnings","parserHadUpdate","parser","on","error","warning","warn","localeRegex","namespaceRegex","createInstance","init","emit","console","file","encoding","done","content","isBuffer","contents","toString","lstatSync","isDirectory","readFileSync","log","filename","basename","parse","entry","key","keyPrefix","parts","split","length","namespace","shift","join","replace","keyWithNamespace","addEntry","maybeSortedLocales","a","resetValues","locale","catalog","resetAndFlag","uniqueCount","uniquePluralsCount","transformEntry","suffix","undefined","separator","value","duplicate","conflict","count","services","pluralResolver","getSuffixes","ordinal","forEach","outputPath","resolve","namespacePath","parsedNamespacePath","namespaceOldPath","dir","name","ext","existingCatalog","getCatalog","existingOldCatalog","newCatalog","oldKeys","old","mergeCount","oldCount","resetFlags","reset","resetCount","oldCatalog","restoreCount","addCount","failOnUpdate","maybeSortedNewCatalog","maybeSortedOldCatalog","compare","deep","pushFile","Object","keys","process","exit","context","contextEntry","assign","push","endsWith","load","JSON","code","text","dump","indent","stringify","chr","n","charCodeAt","substr","auto","crlf","cr","lf","Buffer","from"],"sources":["../src/transform.js"],"sourcesContent":["import { Transform } from 'stream'\nimport eol from 'eol'\nimport fs from 'fs'\nimport path from 'path'\nimport VirtualFile from 'vinyl'\nimport yaml from 'js-yaml'\nimport i18next from 'i18next'\nimport sortKeys from 'sort-keys'\n\nimport {\n  dotPathToHash,\n  mergeHashes,\n  transferValues,\n  makeDefaultSort,\n} from './helpers.js'\nimport Parser from './parser.js'\n\nexport default class i18nTransform extends Transform {\n  constructor(options = {}) {\n    options.objectMode = true\n    super(options)\n\n    this.defaults = {\n      contextSeparator: '_',\n      createOldCatalogs: true,\n      defaultNamespace: 'translation',\n      defaultValue: '',\n      indentation: 2,\n      keepRemoved: false,\n      keySeparator: '.',\n      lexers: {},\n      lineEnding: 'auto',\n      locales: ['en', 'fr'],\n      namespaceSeparator: ':',\n      pluralSeparator: '_',\n      output: 'locales/$LOCALE/$NAMESPACE.json',\n      resetDefaultValueLocale: null,\n      sort: false,\n      verbose: false,\n      customValueTemplate: null,\n      failOnWarnings: false,\n      yamlOptions: null,\n    }\n\n    this.options = { ...this.defaults, ...options }\n    this.options.i18nextOptions = {\n      ...options.i18nextOptions,\n      pluralSeparator: this.options.pluralSeparator,\n      nsSeparator: this.options.namespaceSeparator,\n    }\n\n    if (this.options.keySeparator === false) {\n      this.options.keySeparator = '__!NO_KEY_SEPARATOR!__'\n    }\n    if (this.options.namespaceSeparator === false) {\n      this.options.namespaceSeparator = '__!NO_NAMESPACE_SEPARATOR!__'\n    }\n    this.entries = []\n\n    this.parserHadWarnings = false\n    this.parserHadUpdate = false\n    this.parser = new Parser(this.options)\n    this.parser.on('error', (error) => this.error(error))\n    this.parser.on('warning', (warning) => this.warn(warning))\n\n    this.localeRegex = /\\$LOCALE/g\n    this.namespaceRegex = /\\$NAMESPACE/g\n\n    this.i18next = i18next.createInstance()\n    this.i18next.init(this.options.i18nextOptions)\n  }\n\n  error(error) {\n    this.emit('error', error)\n    if (this.options.verbose) {\n      console.error('\\x1b[31m%s\\x1b[0m', error)\n    }\n  }\n\n  warn(warning) {\n    this.emit('warning', warning)\n    this.parserHadWarnings = true\n    if (this.options.verbose) {\n      console.warn('\\x1b[33m%s\\x1b[0m', warning)\n    }\n  }\n\n  _transform(file, encoding, done) {\n    let content\n    if (file.isBuffer()) {\n      content = file.contents.toString('utf8')\n    } else if (fs.lstatSync(file.path).isDirectory()) {\n      const warning = `${file.path} is a directory: skipping`\n      this.warn(warning)\n      done()\n      return\n    } else {\n      content = fs.readFileSync(file.path, encoding)\n    }\n\n    this.emit('reading', file)\n    if (this.options.verbose) {\n      console.log(`Parsing ${file.path}`)\n    }\n\n    const filename = path.basename(file.path)\n    const entries = this.parser.parse(content, filename)\n\n    for (const entry of entries) {\n      let key = entry.key\n\n      if (entry.keyPrefix) {\n        key = entry.keyPrefix + this.options.keySeparator + key\n      }\n\n      const parts = key.split(this.options.namespaceSeparator)\n\n      // make sure we're not pulling a 'namespace' out of a default value\n      if (parts.length > 1 && key !== entry.defaultValue) {\n        entry.namespace = parts.shift()\n      }\n      entry.namespace = entry.namespace || this.options.defaultNamespace\n\n      key = parts.join(this.options.namespaceSeparator)\n      key = key.replace(/\\\\('|\"|`)/g, '$1')\n      key = key.replace(/\\\\n/g, '\\n')\n      key = key.replace(/\\\\r/g, '\\r')\n      key = key.replace(/\\\\t/g, '\\t')\n      key = key.replace(/\\\\\\\\/g, '\\\\')\n      entry.key = key\n      entry.keyWithNamespace = entry.namespace + this.options.keySeparator + key\n\n      this.addEntry(entry)\n    }\n\n    done()\n  }\n\n  _flush(done) {\n    let maybeSortedLocales = this.options.locales\n    if (this.options.resetDefaultValueLocale) {\n      // ensure we process the reset locale first\n      maybeSortedLocales.sort((a) =>\n        a === this.options.resetDefaultValueLocale ? -1 : 1\n      )\n    }\n\n    // Tracks keys to reset by namespace\n    let resetValues = {}\n\n    for (const locale of maybeSortedLocales) {\n      const catalog = {}\n      const resetAndFlag = this.options.resetDefaultValueLocale === locale\n\n      let uniqueCount = {}\n      let uniquePluralsCount = {}\n\n      const transformEntry = (entry, suffix) => {\n        if (uniqueCount[entry.namespace] === undefined) {\n          uniqueCount[entry.namespace] = 0\n        }\n        if (uniquePluralsCount[entry.namespace] === undefined) {\n          uniquePluralsCount[entry.namespace] = 0\n        }\n\n        const { duplicate, conflict } = dotPathToHash(entry, catalog, {\n          suffix,\n          locale,\n          separator: this.options.keySeparator,\n          pluralSeparator: this.options.pluralSeparator,\n          value: this.options.defaultValue,\n          customValueTemplate: this.options.customValueTemplate,\n        })\n\n        if (duplicate) {\n          if (conflict === 'key') {\n            this.warn(\n              `Found translation key already mapped to a map or parent of ` +\n                `new key already mapped to a string: ${entry.key}`\n            )\n          } else if (conflict === 'value') {\n            this.warn(`Found same keys with different values: ${entry.key}`)\n          }\n        } else {\n          uniqueCount[entry.namespace] += 1\n          if (suffix) {\n            uniquePluralsCount[entry.namespace] += 1\n          }\n        }\n      }\n\n      // generates plurals according to i18next rules: key_zero, key_one, key_two, key_few, key_many and key_other\n      for (const entry of this.entries) {\n        if (entry.count !== undefined) {\n          this.i18next.services.pluralResolver\n            .getSuffixes(locale, { ordinal: entry.ordinal })\n            .forEach((suffix) => {\n              transformEntry(entry, suffix)\n            })\n        } else {\n          transformEntry(entry)\n        }\n      }\n\n      const outputPath = path.resolve(this.options.output)\n\n      for (const namespace in catalog) {\n        let namespacePath = outputPath\n        namespacePath = namespacePath.replace(this.localeRegex, locale)\n        namespacePath = namespacePath.replace(this.namespaceRegex, namespace)\n\n        let parsedNamespacePath = path.parse(namespacePath)\n\n        const namespaceOldPath = path.join(\n          parsedNamespacePath.dir,\n          `${parsedNamespacePath.name}_old${parsedNamespacePath.ext}`\n        )\n\n        let existingCatalog = this.getCatalog(namespacePath)\n        let existingOldCatalog = this.getCatalog(namespaceOldPath)\n\n        // merges existing translations with the new ones\n        const {\n          new: newCatalog,\n          old: oldKeys,\n          mergeCount,\n          oldCount,\n          reset: resetFlags,\n          resetCount,\n        } = mergeHashes(\n          existingCatalog,\n          catalog[namespace],\n          {\n            ...this.options,\n            resetAndFlag,\n          },\n          resetValues[namespace]\n        )\n\n        // record values to be reset\n        // assumes that the 'default' namespace is processed first\n        if (resetAndFlag && !resetValues[namespace]) {\n          resetValues[namespace] = resetFlags\n        }\n\n        // restore old translations\n        const { old: oldCatalog, mergeCount: restoreCount } = mergeHashes(\n          existingOldCatalog,\n          newCatalog,\n          { ...this.options, keepRemoved: false }\n        )\n\n        // backup unused translations\n        transferValues(oldKeys, oldCatalog)\n\n        if (this.options.verbose) {\n          console.log(`[${locale}] ${namespace}`)\n          console.log(\n            `Unique keys: ${uniqueCount[namespace]} (${uniquePluralsCount[namespace]} are plurals)`\n          )\n          const addCount = uniqueCount[namespace] - mergeCount\n          console.log(`Added keys: ${addCount}`)\n          console.log(`Restored keys: ${restoreCount}`)\n          if (this.options.keepRemoved) {\n            console.log(`Unreferenced keys: ${oldCount}`)\n          } else {\n            console.log(`Removed keys: ${oldCount}`)\n          }\n          if (this.options.resetDefaultValueLocale) {\n            console.log(`Reset keys: ${resetCount}`)\n          }\n          console.log('')\n        }\n\n        if (this.options.failOnUpdate) {\n          const addCount = uniqueCount[namespace] - mergeCount\n          if (addCount + restoreCount + oldCount !== 0) {\n            this.parserHadUpdate = true\n            continue\n          }\n        }\n\n        if (this.options.failOnWarnings && this.parserHadWarnings) {\n          continue\n        }\n\n        let maybeSortedNewCatalog = newCatalog\n        let maybeSortedOldCatalog = oldCatalog\n        const { sort } = this.options\n        if (sort) {\n          const compare =\n            typeof sort === 'function'\n              ? sort\n              : makeDefaultSort(this.options.pluralSeparator)\n          maybeSortedNewCatalog = sortKeys(newCatalog, { deep: true, compare })\n          maybeSortedOldCatalog = sortKeys(oldCatalog, { deep: true, compare })\n        }\n\n        // push files back to the stream\n        this.pushFile(namespacePath, maybeSortedNewCatalog)\n        if (\n          this.options.createOldCatalogs &&\n          (Object.keys(oldCatalog).length || existingOldCatalog)\n        ) {\n          this.pushFile(namespaceOldPath, maybeSortedOldCatalog)\n        }\n      }\n    }\n\n    if (this.options.failOnWarnings && this.parserHadWarnings) {\n      this.emit(\n        'error',\n        'Warnings were triggered and failOnWarnings option is enabled. Exiting...'\n      )\n      process.exit(1)\n    }\n\n    if (this.options.failOnUpdate && this.parserHadUpdate) {\n      this.emit(\n        'error',\n        'Some translations was updated and failOnUpdate option is enabled. Exiting...'\n      )\n      process.exit(1)\n    }\n\n    done()\n  }\n\n  addEntry(entry) {\n    if (entry.context) {\n      const contextEntry = Object.assign({}, entry)\n      delete contextEntry.context\n      contextEntry.key += this.options.contextSeparator + entry.context\n      contextEntry.keyWithNamespace +=\n        this.options.contextSeparator + entry.context\n      this.entries.push(contextEntry)\n    } else {\n      this.entries.push(entry)\n    }\n  }\n\n  getCatalog(path) {\n    try {\n      let content\n      if (path.endsWith('yml')) {\n        content = yaml.load(fs.readFileSync(path).toString())\n      } else {\n        content = JSON.parse(fs.readFileSync(path))\n      }\n      return content\n    } catch (error) {\n      if (error.code !== 'ENOENT') {\n        this.emit('error', error)\n      }\n    }\n\n    return null\n  }\n\n  pushFile(path, contents) {\n    let text\n    if (path.endsWith('yml')) {\n      text = yaml.dump(contents, {\n        indent: this.options.indentation,\n        ...this.options.yamlOptions,\n      })\n    } else {\n      text = JSON.stringify(contents, null, this.options.indentation) + '\\n'\n      // Convert non-printable Unicode characters to unicode escape sequence\n      // https://unicode.org/reports/tr18/#General_Category_Property\n      text = text.replace(/[\\p{Z}\\p{Cc}\\p{Cf}]/gu, (chr) => {\n        const n = chr.charCodeAt(0)\n        return n < 128 ? chr : `\\\\u${`0000${n.toString(16)}`.substr(-4)}`\n      })\n    }\n\n    if (this.options.lineEnding === 'auto') {\n      text = eol.auto(text)\n    } else if (\n      this.options.lineEnding === '\\r\\n' ||\n      this.options.lineEnding === 'crlf'\n    ) {\n      text = eol.crlf(text)\n    } else if (\n      this.options.lineEnding === '\\r' ||\n      this.options.lineEnding === 'cr'\n    ) {\n      text = eol.cr(text)\n    } else {\n      // Defaults to LF, aka \\n\n      text = eol.lf(text)\n    }\n\n    const file = new VirtualFile({\n      path,\n      contents: Buffer.from(text),\n    })\n    this.push(file)\n  }\n}\n"],"mappings":"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"}